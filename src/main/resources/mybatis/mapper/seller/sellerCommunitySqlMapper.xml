<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fiveguys.seller.mapper.SellerCommunitySqlMapper">
    <insert id="insertSellerCommunityWrite">
        <selectKey order="AFTER" keyProperty="sellerCommunityNumber" resultType="int">
            select max(sellerCommunityNumber) from fc_sellerCommunity;
        </selectKey>
        insert into fc_sellerCommunity(
            sellerNumber,
            sellerCommunityImage,
            sellerCommunityTitle,
            sellerCommunityContent,
            sellerCommunityVisitCount
       ) values(
            #{sellerNumber},
            #{sellerCommunityImage},
            #{sellerCommunityTitle},
            #{sellerCommunityContent},
            0
       )
    </insert>
    <insert id="insertSellerCommunityImageDetail">
        insert into fc_sellerCommunityImageDetail(
            sellerCommunityNumber,
            sellerCommunityImageList
        )values(
            #{sellerCommunityNumber},
            #{sellerCommunityImageList}
        )
    </insert>
    <select id="selectSeller">
        select * from fc_seller fs
        inner join fc_sellerCommunity fsc
        on fs.sellerNumber =fsc.sellerNumber
        where fsc.sellerCommunityNumber=#{sellerCommunityNumber}
    </select>
    <select id="selectSellerCommunityList">
        select
            sellerCommunityNumber,
            sellerNumber,
            sellerCommunityImage,
            sellerCommunityTitle,
            sellerCommunityContent,
            sellerCommunityVisitCount,
            CASE
                WHEN FLOOR(TIMESTAMPDIFF(MONTH, sellerCommunityCreatedAt, NOW()) / 12) >= 1 THEN CONCAT(FLOOR(TIMESTAMPDIFF(MONTH, sellerCommunityCreatedAt, NOW()) / 12), '년전')
                WHEN TIMESTAMPDIFF(MONTH, sellerCommunityCreatedAt, NOW()) >= 1 THEN CONCAT(TIMESTAMPDIFF(MONTH, sellerCommunityCreatedAt, NOW()), '달전')
                WHEN DATEDIFF(CURRENT_DATE, sellerCommunityCreatedAt) >= 1 THEN CONCAT(DATEDIFF(CURRENT_DATE, sellerCommunityCreatedAt), '일전')
                WHEN TIMESTAMPDIFF(HOUR, sellerCommunityCreatedAt, NOW()) >= 1 THEN CONCAT(TIMESTAMPDIFF(HOUR, sellerCommunityCreatedAt, NOW()), '시간전')
                ELSE CONCAT(TIMESTAMPDIFF(MINUTE, sellerCommunityCreatedAt, NOW()), '분전')
                end as sellerCommunityCreatedAt
        from fc_sellerCommunity
    </select>
    <select id="selectSellerCommunityById">
        select
            sellerCommunityNumber,
            sellerNumber,
            sellerCommunityImage,
            sellerCommunityTitle,
            sellerCommunityContent,
            sellerCommunityVisitCount,
            CASE
                WHEN FLOOR(TIMESTAMPDIFF(MONTH, sellerCommunityCreatedAt, NOW()) / 12) >= 1 THEN CONCAT(FLOOR(TIMESTAMPDIFF(MONTH, sellerCommunityCreatedAt, NOW()) / 12), '년전')
                WHEN TIMESTAMPDIFF(MONTH, sellerCommunityCreatedAt, NOW()) >= 1 THEN CONCAT(TIMESTAMPDIFF(MONTH, sellerCommunityCreatedAt, NOW()), '달전')
                WHEN DATEDIFF(CURRENT_DATE, sellerCommunityCreatedAt) >= 1 THEN CONCAT(DATEDIFF(CURRENT_DATE, sellerCommunityCreatedAt), '일전')
                WHEN TIMESTAMPDIFF(HOUR, sellerCommunityCreatedAt, NOW()) >= 1 THEN CONCAT(TIMESTAMPDIFF(HOUR, sellerCommunityCreatedAt, NOW()), '시간전')
                ELSE CONCAT(TIMESTAMPDIFF(MINUTE, sellerCommunityCreatedAt, NOW()), '분전')
                end as sellerCommunityCreatedAt
        from fc_sellerCommunity
        where sellerCommunityNumber=#{sellerCommunityNumber}
    </select>
    <select id="selectImageListById">
        select * from fc_sellerCommunityImageDetail where sellerCommunityNumber=#{sellerCommunityNumber}
    </select>
    <!--댓글 삽입 쿼리-->
    <insert id="insertSellerCommunityComment">
        insert into fc_sellerCommunityComment(
              sellerCommunityNumber,
              sellerNumber,
              sellerCommunityCommentContent
        ) values(
             #{sellerCommunityNumber},
             #{sellerNumber},
             #{sellerCommunityCommentContent}
        )
    </insert>
    <select id="selectSellerCommunityComment" resultType="map">
        select * from fc_sellerCommunityComment scc
        inner join fc_seller fs
        on scc.sellerNumber  =fs.sellerNumber
        where sellerCommunityNumber=#{sellerCommunityNumber}
    </select>

    <!--대댓글 삽입 쿼리-->
    <insert id="insertSellerCommunityReply">
        insert into fc_sellerCommunityReply(
            sellerCommunityCommentNumber,
            sellerNumber,
            sellerCommunityReplyContent
        ) values(
            #{sellerCommunityCommentNumber},
            #{sellerNumber},
            #{sellerCommunityReplyContent}
        )
    </insert>
    <select id="selectSellerCommunityReply" resultType="map">
        select * from fc_sellerCommunityReply fsc
        inner join fc_seller fs
        on fsc.sellerNumber  =fs.sellerNumber
        where sellerCommunityCommentNumber=#{sellerCommunityCommentNumber}
    </select>

    <!--채팅수 표시 댓글 +대댓글-->
    <select id="selectTotalCommentCount">
       select coalesce(count(*),0) from  fc_sellerCommunityComment where sellerCommunityNumber=#{sellerCommunityNumber}
    </select>
    <select id="selectTotalReplyCount">
        select coalesce(count(*),0) from  fc_sellerCommunityReply fsr
        inner join fc_sellerCommunityComment fsc
        on fsr.sellerCommunityCommentNumber =fsc.sellerCommunityCommentNumber
        where fsc.sellerCommunityNumber =#{sellerCommunityNumber}
    </select>
    <!--댓글당 대댓글 카운트-->
    <select id="selectEachSellerCommentReplyCount">
        select coalesce(count(*),0) from fc_sellerCommunityReply
        where sellerCommunityCommentNumber=#{sellerCommunityCommentNumber}
    </select>

    <!--게시글 좋아요 싫어요-->
    <insert id="insertSellerCommunityLike">
        insert into fc_sellerCommunityLike(
            sellerCommunityNumber,
            sellerNumber
        ) values(
            #{sellerCommunityNumber},
            #{sellerNumber}
        )
    </insert>
    <select id="selectSellerCommunityLikeCount">
        select coalesce(count(*),0) from fc_sellerCommunityLike where sellerCommunityNumber=#{sellerCommunityNumber}
    </select>
    <delete id="deleteSellerCommunityLike">
        delete from fc_sellerCommunityLike
        where sellerCommunityNumber=#{sellerCommunityNumber} and sellerNumber=#{sellerNumber}
    </delete>
    <select id="checkIfSellerCommunityLikeExists">
        select coalesce(count(*),0) from fc_sellerCommunityLike  where sellerNumber=#{sellerNumber} and sellerCommunityNumber=#{sellerCommunityNumber}
    </select>

    <!--조회수 카운트 증가-->
    <update id="updateSellerCommunityVisitCount">
        update fc_sellerCommunity
        set sellerCommunityVisitCount =sellerCommunityVisitCount+1
        where sellerCommunityNumber=#{sellerCommunityNumber}
    </update>

    <!--댓글 좋아요 싫어요 상태 삽입-->
    <insert id="insertSellerCommentLikeStatus">
        insert into fc_sellerCommunityCommentLikeStatus(
            sellerCommunityCommentNumber,
            sellerNumber,
            sellerCommentLikeStatus
        ) values(
            #{sellerCommunityCommentNumber},
            #{sellerNumber},
            ''
        )
    </insert>
    <select id ="selectSellerCommentLikeStatus">
        select * from fc_sellerCommunityCommentLikeStatus
        where sellerCommunityCommentNumber=#{sellerCommunityCommentNumber} and sellerNumber=#{sellerNumber}
    </select>
    <update id="updateSellerCommentLikeStatus">
        update fc_sellerCommunityCommentLikeStatus
        set sellerCommentLikeStatus=#{sellerCommentLikeStatus}
        where sellerNumber=#{sellerNumber} and sellerCommunityCommentNumber=#{sellerCommunityCommentNumber}
    </update>
    <select id="selectSellerCommentLikeCount">
        select coalesce(count(*),0) from fc_sellerCommunityCommentLikeStatus
        where sellerCommunityCommentNumber=#{sellerCommunityCommentNumber} and sellerCommentLikeStatus='like'
    </select>
    <select id="selectSellerCommentDisLikeCount">
        select coalesce(count(*),0) from fc_sellerCommunityCommentLikeStatus
        where sellerCommunityCommentNumber=#{sellerCommunityCommentNumber} and sellerCommentLikeStatus='dislike'
    </select>

    <!--대댓글좋아요 싫어요 상태 삽입-->
    <insert id="insertSellerReplyLikeStatus">
        insert into fc_sellerCommunityReplyLikeStatus(
            sellerCommunityReplyNumber,
            sellerNumber,
            sellerCommunityReplyLikeStatus
        ) values(
            #{sellerCommunityReplyNumber},
            #{sellerNumber},
            ''
        )
    </insert>
    <select id ="selectSellerReplyLikeStatus">
        select * from fc_sellerCommunityReplyLikeStatus
        where sellerCommunityReplyNumber=#{sellerCommunityReplyNumber} and sellerNumber=#{sellerNumber}
    </select>
    <update id="updateSellerReplyLikeStatus">
        update fc_sellerCommunityReplyLikeStatus
        set sellerCommunityReplyLikeStatus=#{sellerCommunityReplyLikeStatus}
        where sellerNumber=#{sellerNumber} and sellerCommunityReplyNumber=#{sellerCommunityReplyNumber}
    </update>
    <select id="selectSellerReplyLikeCount">
        select coalesce(count(*),0) from fc_sellerCommunityReplyLikeStatus
        where sellerCommunityReplyNumber=#{sellerCommunityReplyNumber} and sellerCommunityReplyLikeStatus='like'
    </select>
    <select id="selectSellerReplyDisLikeCount">
        select coalesce(count(*),0) from fc_sellerCommunityReplyLikeStatus
        where sellerCommunityReplyNumber=#{sellerCommunityReplyNumber} and sellerCommunityReplyLikeStatus='dislike'
    </select>
</mapper>